<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœˆå ±ç®¡ç† - {{ project.name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
    </style>
</head>
<body class="bg-indigo-50 min-h-screen">
    <!-- Navbar -->
    <nav class="bg-indigo-700 shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-4">
                    <a href="{{ url_for('index') }}" class="text-indigo-200 font-bold hover:text-white">
                        &larr; å›é¦–é 
                    </a>
                    <span class="text-white text-lg font-semibold border-l border-indigo-500 pl-4">{{ project.name }}</span>
                    <span class="bg-indigo-800 text-indigo-200 text-xs px-2 py-1 rounded">Monthly Mode</span>
                </div>
                <!-- Debug Indicator -->
                {% if project.features.get('debug') %}
                <div class="flex items-center text-yellow-300 text-xs font-mono bg-indigo-900 px-2 py-1 rounded">
                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                    DEBUG MODE ENABLED
                </div>
                {% endif %}
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6">
        
        <!-- Header & Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="md:col-span-3 bg-white p-6 rounded-lg shadow border-l-4 border-indigo-500">
                <h1 class="text-2xl font-bold text-slate-800 mb-2">å°ˆæ¡ˆå„€è¡¨æ¿</h1>
                <p class="text-slate-600">{{ project.description }}</p>
                <div class="mt-4 flex gap-2">
                    <span class="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">Created: {{ project.created_at[:10] }}</span>
                    {% if project.features.get('daily') %}
                    <span class="text-xs text-emerald-600 bg-emerald-100 px-2 py-1 rounded">æ¯æ—¥æš«å­˜å•Ÿç”¨</span>
                    {% endif %}
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 transition" onclick="document.getElementById('viewModeList').click()">
                <span class="text-4xl font-bold text-indigo-600" id="entryCount">-</span>
                <span class="text-sm text-slate-500">æœ¬æœˆç´€éŒ„ (Accumulated)</span>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div class="flex items-center space-x-4">
                <h2 class="text-xl font-bold text-slate-800">æ¯æ—¥ç´€éŒ„ (Entries)</h2>
                
                <!-- View Toggle -->
                <div class="bg-indigo-100 p-1 rounded-lg flex text-xs font-bold">
                    <button id="viewModeList" class="px-3 py-1 bg-white text-indigo-700 rounded shadow-sm transition-all" onclick="switchView('list')">åˆ—è¡¨ (List)</button>
                    <button id="viewModeCal" class="px-3 py-1 text-indigo-500 hover:text-indigo-700 transition-all" onclick="switchView('calendar')">æ—¥æ›† (Calendar)</button>
                </div>
            </div>

            <div class="space-x-4">
                <button onclick="openEntryModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded shadow flex items-center transition transform hover:-translate-y-0.5">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    æ–°å¢ä»Šæ—¥è³‡æ–™
                </button>
                {% if project.features.get('monthly') %}
                <button id="btnGenerateMonthly" onclick="generateMonthlyReport()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded shadow flex items-center transition transform hover:-translate-y-0.5">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    æœˆå ±çµ±æ•´è¼¸å‡º
                </button>
                {% endif %}
            </div>
        </div>

        <!-- View 1: Entries List -->
        <div id="entriesList" class="bg-white shadow rounded-lg min-h-[300px] p-6">
            <div class="text-center text-slate-400 py-10">è³‡æ–™è¼‰å…¥ä¸­...</div>
        </div>

        <!-- View 2: Calendar (Hidden by default) -->
        <div id="entriesCalendar" class="bg-white shadow rounded-lg min-h-[300px] p-6 hidden">
             <div class="flex justify-between items-center mb-4">
                 <button class="text-slate-400 hover:text-slate-600" id="prevMonth">&larr;</button>
                 <h3 class="text-lg font-bold text-slate-700" id="calMonthTitle">YYYY-MM</h3>
                 <button class="text-slate-400 hover:text-slate-600" id="nextMonth">&rarr;</button>
             </div>
             <div class="grid grid-cols-7 gap-2 mb-2 text-center text-xs font-bold text-slate-400 uppercase">
                 <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
             </div>
             <div class="grid grid-cols-7 gap-2" id="calGrid">
                 <!-- Days injected by JS -->
             </div>
        </div>

        <!-- Debug Panel -->
        {% if project.features.get('debug') %}
        <div class="mt-12 border-t-2 border-slate-300 pt-6">
            <h3 class="font-mono font-bold text-slate-600 mb-4">Developer Console</h3>
            <div class="bg-slate-900 text-green-400 p-4 rounded text-xs font-mono overflow-auto h-64 shadow-inner">
                <pre id="debugLog">Loading project config...
ID: {{ project_id }}
Mode: {{ project.mode }}
Features: {{ project.features }}
Parameters: {{ project.parameters | length }} found.
</pre>
            </div>
        </div>
        {% endif %}

    </main>

    <!-- Entry Modal Overlay -->
    <div id="entryModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        
        <div class="modal-container bg-white w-11/12 md:max-w-3xl mx-auto rounded shadow-lg z-50 overflow-y-auto max-h-[90vh] transition-transform duration-300 transform scale-95">
            
            <div class="modal-content py-4 text-left px-6">
                <!-- Title -->
                <div class="flex justify-between items-center pb-3 border-b">
                    <p class="text-2xl font-bold text-slate-800">æ–°å¢ç´€éŒ„</p>
                    <div class="modal-close cursor-pointer z-50 text-slate-400 hover:text-slate-600" onclick="closeEntryModal()">
                        <svg class="fill-current" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                            <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
                        </svg>
                    </div>
                </div>

                <!-- Dynamic Form Container -->
                <form id="dailyForm" class="mt-4 space-y-4">
                    <!-- Date Picker (Always needed for daily logs) -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">æ—¥æœŸ</label>
                        <input type="date" name="entry_date" id="entryDate" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>

                    <div id="dynamicFields" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Fields injected by JS -->
                    </div>
                </form>

                <!-- Footer -->
                <div class="flex justify-end pt-4 space-x-2 mt-6 border-t">
                    <button onclick="closeEntryModal()" class="px-4 py-2 rounded-lg text-slate-500 hover:bg-slate-100 font-medium">å–æ¶ˆ</button>
                    <button id="btnSaveEntry" class="px-6 py-2 bg-indigo-600 rounded-lg text-white hover:bg-indigo-700 font-bold shadow">
                        ä¿å­˜æš«å­˜
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const PROJECT_ID = "{{ project_id }}";
        const PARAMETERS = {{ project.parameters | tojson }};
        // Mock Data for now
        let entries = [];
        
        document.addEventListener('DOMContentLoaded', () => {
            const dateInput = document.getElementById('entryDate');
            if(dateInput) dateInput.valueAsDate = new Date();
            
            renderFormFields();
            loadEntries(); // Will call API soon
            
            // Modal Effects
            const modalContainer = document.querySelector('.modal-container');
            if(modalContainer) {
                 modalContainer.addEventListener('click', e => e.stopPropagation());
            }
            document.querySelector('.modal-overlay').addEventListener('click', closeEntryModal);
        });

        function renderFormFields() {
            const container = document.getElementById('dynamicFields');
            if(!container) return;
            
            container.innerHTML = '';
            
            PARAMETERS.forEach(p => {
                const div = document.createElement('div');
                div.className = "mb-2";
                
                const label = document.createElement('label');
                label.className = "block text-sm font-medium text-slate-700 mb-1";
                label.textContent = `${p.description} (${p.name})`;
                div.appendChild(label);

                let input;
                if (p.type === 'image') {
                    // Image specific input
                    input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.className = "block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100";
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.className = "shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline focus:border-indigo-500";
                    if (p.example) input.placeholder = `ä¾‹: ${p.example}`;
                }
                input.name = p.name;
                div.appendChild(input);

                container.appendChild(div);
            });
        }
        
        function openEntryModal() {
            const modal = document.getElementById('entryModal');
            const container = modal.querySelector('.modal-container');
            
            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
            
            // Animation
            setTimeout(() => {
                container.classList.remove('scale-95');
                container.classList.add('scale-100');
            }, 10);
        }

        function closeEntryModal() {
            const modal = document.getElementById('entryModal');
            const container = modal.querySelector('.modal-container');
            
            container.classList.remove('scale-100');
            container.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('opacity-0', 'pointer-events-none');
                document.body.classList.remove('modal-active');
            }, 150);
        }

        // --- View Logic (List vs Calendar) ---
        let currentMonth = new Date();
        
        function switchView(mode) {
            const listDiv = document.getElementById('entriesList');
            const calDiv = document.getElementById('entriesCalendar');
            const btnList = document.getElementById('viewModeList');
            const btnCal = document.getElementById('viewModeCal');

            if(mode === 'list') {
                listDiv.classList.remove('hidden');
                calDiv.classList.add('hidden');
                
                btnList.className = "px-3 py-1 bg-white text-indigo-700 rounded shadow-sm transition-all";
                btnCal.className = "px-3 py-1 text-indigo-500 hover:text-indigo-700 transition-all";
            } else {
                listDiv.classList.add('hidden');
                calDiv.classList.remove('hidden');
                
                btnCal.className = "px-3 py-1 bg-white text-indigo-700 rounded shadow-sm transition-all";
                btnList.className = "px-3 py-1 text-indigo-500 hover:text-indigo-700 transition-all";
                
                renderCalendar();
            }
        }

        document.getElementById('prevMonth').addEventListener('click', () => {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            renderCalendar();
        });
        document.getElementById('nextMonth').addEventListener('click', () => {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            renderCalendar();
        });

        function renderCalendar() {
             const year = currentMonth.getFullYear();
             const month = currentMonth.getMonth();
             
             document.getElementById('calMonthTitle').textContent = `${year}-${(month+1).toString().padStart(2, '0')}`;
             
             const firstDay = new Date(year, month, 1).getDay(); // 0-6 (Sun-Sat)
             const daysInMonth = new Date(year, month + 1, 0).getDate();
             
             const grid = document.getElementById('calGrid');
             grid.innerHTML = '';

             // Empty cells for padding
             for(let i=0; i<firstDay; i++) {
                 const cell = document.createElement('div');
                 cell.className = "h-24 bg-slate-50 rounded border border-slate-100";
                 grid.appendChild(cell);
             }

             // Days
             for(let d=1; d<=daysInMonth; d++) {
                 const cell = document.createElement('div');
                 const dateStr = `${year}-${(month+1).toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
                 
                 // Check if entry exists for this day
                 const dayEntries = entries.filter(e => e.date === dateStr);
                 
                 let cellClass = "h-24 bg-white rounded border border-slate-200 p-2 relative hover:shadow transition cursor-pointer";
                 if(dayEntries.length > 0) {
                     cellClass += " border-emerald-400 bg-emerald-50";
                 }
                 
                 cell.className = cellClass;
                 cell.innerHTML = `<span class="text-xs font-bold text-slate-400 absolute top-2 right-2">${d}</span>`;
                 
                 if(dayEntries.length > 0) {
                     const summaryDiv = document.createElement('div');
                     summaryDiv.className = "mt-4 text-xs text-emerald-700 space-y-1 overflow-hidden";
                     dayEntries.forEach(entry => {
                         let summary = '-';
                         if (PARAMETERS.length > 0 && entry.data) {
                             summary = entry.data[PARAMETERS[0].name] || '<No Data>';
                             if(summary.includes('uploads/')) summary = 'ğŸ“· [åœ–ç‰‡]';
                         }
                         summaryDiv.innerHTML += `<div class="truncate">â€¢ ${summary}</div>`;
                     });
                     cell.appendChild(summaryDiv);
                 }
                 
                 // Click on day to add entry
                 cell.addEventListener('click', () => {
                     document.getElementById('entryDate').value = dateStr;
                     openEntryModal();
                 });

                 grid.appendChild(cell);
             }
        }

        // --- API Calls ---

        function loadEntries() {
            const entriesList = document.getElementById('entriesList');
            const entryCount = document.getElementById('entryCount');
            
            // Fetch from API (Task 3)
            fetch(`/api/project/${PROJECT_ID}/entries`)
                .then(r => r.json())
                .then(data => {
                    entries = data.entries || [];
                    entryCount.textContent = entries.length;
                    renderEntriesList(entries);
                    
                    // If Calendar is visible, re-render
                    if(!document.getElementById('entriesCalendar').classList.contains('hidden')) {
                        renderCalendar();
                    }
                })
                .catch(err => {
                    console.error(err);
                    entriesList.innerHTML = `<p class="text-center text-red-500 py-10">ç„¡æ³•è¼‰å…¥è³‡æ–™</p>`;
                });
        }

        function renderEntriesList(list) {
            const container = document.getElementById('entriesList');
            if (list.length === 0) {
                container.innerHTML = `<div class="text-center py-10"><p class="text-slate-500 text-lg">ç›®å‰æ²’æœ‰ç´€éŒ„</p><p class="text-slate-400 text-sm">é»æ“Šå³ä¸Šè§’æ–°å¢ä»Šæ—¥è³‡æ–™</p></div>`;
                return;
            }

            let html = `
                <div class="overflow-x-auto">
                    <table class="min-w-full leading-normal">
                        <thead>
                            <tr>
                                <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">æ—¥æœŸ</th>
                                <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">æ‘˜è¦ (ç¬¬ä¸€æ¬„ä½)</th>
                                <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">å»ºç«‹æ™‚é–“</th>
                                <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">æ“ä½œ</th>
                            </tr>
                        </thead>
                    <tbody>`;
            
            list.forEach(item => {
                // Find first param value for summary
                let summary = '-';
                if (PARAMETERS.length > 0 && item.data) {
                    summary = item.data[PARAMETERS[0].name] || '-';
                    // Truncate if image path
                    if (summary.includes('uploads/')) summary = '[åœ–ç‰‡]';
                }

                html += `
                    <tr>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            <span class="text-gray-900 whitespace-no-wrap font-bold">${item.date}</span>
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            <p class="text-gray-900 whitespace-no-wrap">${summary}</p>
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            <span class="relative inline-block px-3 py-1 font-semibold text-green-900 leading-tight">
                                <span aria-hidden="true" class="absolute inset-0 bg-green-200 opacity-50 rounded-full"></span>
                                <span class="relative">${new Date(item.created_at).toLocaleString()}</span>
                            </span>
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-right">
                            <button onclick="editEntry('${item.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2">ç·¨è¼¯</button>
                            <button onclick="deleteEntry('${item.id}')" class="text-red-600 hover:text-red-900">åˆªé™¤</button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        // --- Save Action ---
        document.getElementById('btnSaveEntry').addEventListener('click', () => {
             const form = document.getElementById('dailyForm');
             const formData = new FormData(form);
             
             // Initial UI Feedback
             const btn = document.getElementById('btnSaveEntry');
             const originalText = btn.textContent;
             btn.disabled = true;
             btn.textContent = 'Saving...';

             fetch(`/api/project/${PROJECT_ID}/entry`, {
                 method: 'POST',
                 body: formData
             })
             .then(r => r.json())
             .then(data => {
                 if(data.success) {
                     closeEntryModal();
                     loadEntries();
                     form.reset();
                     document.getElementById('entryDate').valueAsDate = new Date();
                 } else {
                     alert('Save failed: ' + data.error);
                 }
             })
             .catch(err => {
                 console.error(err);
                 alert('Error saving entry');
             })
             .finally(() => {
                 btn.disabled = false;
                 btn.textContent = originalText;
             });
        });

        // --- Generate Monthly Report ---
        function generateMonthlyReport() {
            const btn = document.getElementById('btnGenerateMonthly');
            if(!btn) return;
            
            // Debug Feedback
            console.log('Starting generation...');
            
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>ç”Ÿæˆä¸­...`;

            fetch(`/api/project/${PROJECT_ID}/generate_monthly`, { method: 'POST' })
            .then(response => {
                if (response.ok) {
                     return response.blob();
                }
                return response.text().then(text => { throw new Error(text || 'Server Error') });
            })
            .then(blob => {
                 const url = window.URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 a.href = url;
                 a.download = `Monthly_Report_${PROJECT_ID.substring(0,8)}.xlsx`;
                 document.body.appendChild(a);
                 a.click();
                 a.remove();
                 // alert('ä¸‹è¼‰å·²é–‹å§‹'); // Optional feedback
            })
            .catch(err => {
                console.error(err);
                alert('Generation failed: ' + err.message);
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            });
        }

        // --- Edit / Delete ---
        function deleteEntry(entryId) {
             if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—?')) return;
             
             fetch(`/api/project/${PROJECT_ID}/entry/${entryId}`, { method: 'DELETE' })
             .then(r => r.json())
             .then(data => {
                  if(data.success) {
                      loadEntries();
                  } else {
                      alert('åˆªé™¤å¤±æ•—');
                  }
             });
        }
        
        function editEntry(entryId) {
             const entry = entries.find(e => e.id === entryId);
             if(!entry) return;
             
             document.getElementById('entryDate').value = entry.date;
             
             // Populate fields
             PARAMETERS.forEach(p => {
                 const inputs = document.getElementsByName(p.name);
                 if(inputs.length > 0) {
                     const input = inputs[0];
                     if(p.type === 'image') {
                         // Cannot set file input value
                     } else {
                         input.value = entry.data[p.name] || '';
                     }
                 }
             });
             
             openEntryModal();
        }


    </script>
</body>
</html>